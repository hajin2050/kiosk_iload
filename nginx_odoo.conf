# Nginx 설정 - Odoo 리버스 프록시
# /etc/nginx/sites-available/odoo 또는 /usr/local/etc/nginx/nginx.conf

upstream odoo {
    server 127.0.0.1:8069;
}

upstream odoochat {
    server 127.0.0.1:8072;  # longpolling port (있는 경우)
}

# HTTP → HTTPS 리다이렉트 (프로덕션용)
# server {
#     listen 80;
#     server_name your-domain.com;
#     return 301 https://$server_name$request_uri;
# }

server {
    listen 80;  # 또는 443 ssl;
    server_name localhost;  # 또는 your-domain.com
    
    # SSL 설정 (프로덕션용)
    # ssl_certificate /path/to/certificate.crt;
    # ssl_certificate_key /path/to/private.key;
    
    # 로그 설정
    access_log /var/log/nginx/odoo.access.log;
    error_log /var/log/nginx/odoo.error.log;
    
    # 업로드 크기 제한
    client_max_body_size 200M;
    
    # Gzip 압축
    gzip on;
    gzip_types text/css text/js text/xml text/plain application/javascript application/xml+rss application/json;
    
    # 루트(/) → /web 자동 리다이렉트
    location = / {
        return 301 /web;
    }
    
    # Odoo 백엔드 프록시
    location / {
        proxy_pass http://odoo;
        proxy_redirect off;
        
        # 헤더 설정 (16.0/17.0 공통)
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # 버퍼 설정
        proxy_buffering off;
        proxy_buffer_size 64k;
        proxy_busy_buffers_size 64k;
        
        # 타임아웃 설정
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 300s;
    }
    
    # 롱폴링 지원 (chat, 알림 등)
    location /longpolling {
        proxy_pass http://odoochat;  # 8072 포트
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 정적 파일 캐싱 (CSS, JS, 이미지)
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        proxy_pass http://odoo;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 보안 헤더
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
}

# 설정 테스트: nginx -t
# 재시작: sudo systemctl restart nginx
# 또는: sudo nginx -s reload